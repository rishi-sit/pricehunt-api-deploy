<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceHunt Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { @apply bg-white rounded-xl shadow-lg p-6; }
        .stat-card { @apply bg-white rounded-xl shadow-md p-4 border-l-4; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 px-8 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">üîç PriceHunt Analytics</h1>
                <p class="text-purple-200 text-sm">Real-time scraping & AI processing metrics</p>
            </div>
            <div class="flex items-center gap-4">
                <select id="deviceSelect" class="bg-white/20 text-white border border-white/30 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white/50">
                    <option value="">Loading devices...</option>
                </select>
                <button onclick="refreshData()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition flex items-center gap-2">
                    <span>üîÑ</span> Refresh
                </button>
            </div>
        </div>
    </header>

    <!-- Date Range Selector -->
    <div class="max-w-7xl mx-auto px-8 py-4">
        <div class="bg-white rounded-lg shadow p-4 flex items-center gap-4 flex-wrap">
            <label class="text-gray-600 font-medium">Date Range:</label>
            <input type="date" id="startDate" class="border rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none">
            <span class="text-gray-400">to</span>
            <input type="date" id="endDate" class="border rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none">
            <button onclick="loadDashboard()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                Apply
            </button>
            <div class="flex gap-2 ml-auto">
                <button onclick="setDateRange('today')" class="text-purple-600 hover:bg-purple-50 px-3 py-1 rounded transition">Today</button>
                <button onclick="setDateRange('week')" class="text-purple-600 hover:bg-purple-50 px-3 py-1 rounded transition">Last 7 days</button>
                <button onclick="setDateRange('month')" class="text-purple-600 hover:bg-purple-50 px-3 py-1 rounded transition">Last 30 days</button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="max-w-7xl mx-auto px-8 py-20 text-center hidden">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-gray-500">Loading analytics data...</p>
    </div>

    <!-- No Data State -->
    <div id="noDataState" class="max-w-7xl mx-auto px-8 py-20 text-center hidden">
        <div class="text-6xl mb-4">üìä</div>
        <h2 class="text-xl font-semibold text-gray-700 mb-2">No Analytics Data Yet</h2>
        <p class="text-gray-500">Select a device and date range to view analytics</p>
    </div>

    <!-- Dashboard Content -->
    <main id="dashboardContent" class="max-w-7xl mx-auto px-8 py-6 hidden">
        <!-- Summary Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 fade-in">
            <div class="stat-card border-blue-500">
                <p class="text-gray-500 text-sm">Total Scrapes</p>
                <p id="totalScrapes" class="text-3xl font-bold text-gray-800">-</p>
                <p class="text-xs text-gray-400 mt-1">All platforms combined</p>
            </div>
            <div class="stat-card border-green-500">
                <p class="text-gray-500 text-sm">Success Rate</p>
                <p id="successRate" class="text-3xl font-bold text-green-600">-</p>
                <p class="text-xs text-gray-400 mt-1">Successful extractions</p>
            </div>
            <div class="stat-card border-purple-500">
                <p class="text-gray-500 text-sm">Products Found</p>
                <p id="totalProducts" class="text-3xl font-bold text-purple-600">-</p>
                <p class="text-xs text-gray-400 mt-1">Total products scraped</p>
            </div>
            <div class="stat-card border-orange-500">
                <p class="text-gray-500 text-sm">Relevant Products</p>
                <p id="relevantProducts" class="text-3xl font-bold text-orange-600">-</p>
                <p class="text-xs text-gray-400 mt-1">After AI filtering</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Scrape Source Chart -->
            <div class="card fade-in">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üì° Scrape Source Distribution</h3>
                <div class="h-64">
                    <canvas id="scrapeSourceChart"></canvas>
                </div>
            </div>

            <!-- Platform Performance Chart -->
            <div class="card fade-in">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üè™ Products by Platform</h3>
                <div class="h-64">
                    <canvas id="platformChart"></canvas>
                </div>
            </div>
        </div>

        <!-- AI Processing Stats -->
        <div class="card mb-6 fade-in">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">ü§ñ AI Processing Stats</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600">Total AI Requests</span>
                        <span id="aiTotalRequests" class="font-semibold">-</span>
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600">Successful</span>
                        <span id="aiSuccessful" class="font-semibold text-green-600">-</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Failed</span>
                        <span id="aiFailed" class="font-semibold text-red-600">-</span>
                    </div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600">Avg Latency</span>
                        <span id="aiAvgLatency" class="font-semibold">-</span>
                    </div>
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600">Products Found</span>
                        <span id="aiProductsFound" class="font-semibold text-purple-600">-</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Products Filtered</span>
                        <span id="aiProductsFiltered" class="font-semibold text-orange-600">-</span>
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500 mb-2">Provider Distribution</h4>
                    <div id="providerStats" class="space-y-2">
                        <p class="text-gray-400 text-sm">No AI data</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Platform Details Table -->
        <div class="card mb-6 fade-in">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä Platform Details</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Platform</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Scrapes</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Success Rate</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Products</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Relevant</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg HTML (KB)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg Latency</th>
                        </tr>
                    </thead>
                    <tbody id="platformTable" class="divide-y divide-gray-200">
                        <tr><td colspan="7" class="px-4 py-8 text-center text-gray-400">No platform data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Logs -->
        <div class="card fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">üìù Recent Scrape Logs</h3>
                <select id="logPlatformFilter" onchange="filterLogs()" class="border rounded-lg px-3 py-1 text-sm">
                    <option value="">All Platforms</option>
                </select>
            </div>
            <div class="overflow-x-auto max-h-96">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-white">
                        <tr class="bg-gray-50">
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Time</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Platform</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Query</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Source</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Products</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable" class="divide-y divide-gray-100">
                        <tr><td colspan="6" class="px-3 py-8 text-center text-gray-400">No logs yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-6 text-gray-400 text-sm">
        <p>PriceHunt Analytics Dashboard ‚Ä¢ Built with ‚ù§Ô∏è</p>
    </footer>

    <script>
        // Global state
        let currentDeviceId = '';
        let scrapeSourceChart = null;
        let platformChart = null;
        let allLogs = [];

        // API Base URL (same origin)
        const API_BASE = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setDateRange('today');
            loadDevices();
        });

        // Set date range shortcuts
        function setDateRange(range) {
            const today = new Date();
            const endDate = today.toISOString().split('T')[0];
            let startDate = endDate;

            if (range === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                startDate = weekAgo.toISOString().split('T')[0];
            } else if (range === 'month') {
                const monthAgo = new Date(today);
                monthAgo.setDate(monthAgo.getDate() - 30);
                startDate = monthAgo.toISOString().split('T')[0];
            }

            document.getElementById('startDate').value = startDate;
            document.getElementById('endDate').value = endDate;
            
            if (currentDeviceId) {
                loadDashboard();
            }
        }

        // Load available devices
        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/devices`);
                const data = await response.json();
                
                const select = document.getElementById('deviceSelect');
                select.innerHTML = '<option value="">Select a device...</option>';
                
                if (data.success && data.devices && data.devices.length > 0) {
                    data.devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.device_id;
                        option.textContent = `${device.device_id.substring(0, 8)}... (${device.total_logs} logs)`;
                        select.appendChild(option);
                    });
                    
                    // Auto-select first device
                    if (data.devices.length > 0) {
                        currentDeviceId = data.devices[0].device_id;
                        select.value = currentDeviceId;
                        loadDashboard();
                    }
                } else {
                    select.innerHTML = '<option value="">No devices found</option>';
                    showNoData();
                }
                
                select.addEventListener('change', (e) => {
                    currentDeviceId = e.target.value;
                    if (currentDeviceId) {
                        loadDashboard();
                    } else {
                        showNoData();
                    }
                });
            } catch (error) {
                console.error('Failed to load devices:', error);
                document.getElementById('deviceSelect').innerHTML = '<option value="">Error loading devices</option>';
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            if (!currentDeviceId) {
                showNoData();
                return;
            }

            showLoading();

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            try {
                // Fetch combined analytics
                const [dashboardRes, logsRes] = await Promise.all([
                    fetch(`${API_BASE}/api/analytics/combined/${currentDeviceId}?start_date=${startDate}&end_date=${endDate}`),
                    fetch(`${API_BASE}/api/analytics/logs/${currentDeviceId}?limit=100`)
                ]);

                const dashboardData = await dashboardRes.json();
                const logsData = await logsRes.json();

                if (dashboardData.success) {
                    renderDashboard(dashboardData.data);
                }

                if (logsData.success) {
                    allLogs = logsData.logs || [];
                    renderLogs(allLogs);
                    populatePlatformFilter();
                }

                showDashboard();
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                showNoData();
            }
        }

        // Render dashboard
        function renderDashboard(data) {
            const scrapeStats = data.scrape_stats?.data || data.scrape_stats || {};
            const aiStats = data.ai_processing_stats || {};

            // Summary stats
            document.getElementById('totalScrapes').textContent = scrapeStats.total_logs || 0;
            const successRate = scrapeStats.total_logs > 0 
                ? Math.round((scrapeStats.successful || 0) / scrapeStats.total_logs * 100) 
                : 0;
            document.getElementById('successRate').textContent = `${successRate}%`;
            document.getElementById('totalProducts').textContent = scrapeStats.total_products_scraped || 0;
            document.getElementById('relevantProducts').textContent = scrapeStats.total_relevant_products || 0;

            // Scrape source chart
            const scrapeBySource = scrapeStats.scrape_source_breakdown || {};
            renderScrapeSourceChart(scrapeBySource);

            // Platform chart
            const platformStats = scrapeStats.platform_stats || [];
            renderPlatformChart(platformStats);

            // Platform table
            renderPlatformTable(platformStats);

            // AI Stats
            document.getElementById('aiTotalRequests').textContent = aiStats.total_requests || 0;
            document.getElementById('aiSuccessful').textContent = aiStats.successful || 0;
            document.getElementById('aiFailed').textContent = aiStats.failed || 0;
            document.getElementById('aiAvgLatency').textContent = `${aiStats.avg_latency_ms || 0}ms`;
            document.getElementById('aiProductsFound').textContent = aiStats.total_products_found || 0;
            document.getElementById('aiProductsFiltered').textContent = aiStats.total_products_filtered || 0;

            // Provider stats
            const providerStatsDiv = document.getElementById('providerStats');
            const providerStats = aiStats.provider_stats || [];
            if (providerStats.length > 0) {
                providerStatsDiv.innerHTML = providerStats.map(p => `
                    <div class="flex items-center justify-between bg-gray-50 rounded px-2 py-1">
                        <span class="text-sm">
                            <span class="font-medium">${p.provider}</span>
                            <span class="text-gray-400 text-xs">(${p.model || 'unknown'})</span>
                        </span>
                        <span class="text-sm font-medium">${p.requests} reqs</span>
                    </div>
                `).join('');
            } else {
                providerStatsDiv.innerHTML = '<p class="text-gray-400 text-sm">No AI processing data</p>';
            }
        }

        // Render scrape source chart
        function renderScrapeSourceChart(data) {
            const ctx = document.getElementById('scrapeSourceChart').getContext('2d');
            
            if (scrapeSourceChart) {
                scrapeSourceChart.destroy();
            }

            const labels = Object.keys(data);
            const values = Object.values(data);
            const colors = {
                'device': '#10B981',
                'ai_fallback': '#8B5CF6',
                'playwright': '#F59E0B',
                'cache': '#6B7280'
            };

            scrapeSourceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.replace('_', ' ').toUpperCase()),
                    datasets: [{
                        data: values,
                        backgroundColor: labels.map(l => colors[l] || '#CBD5E1'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Render platform chart
        function renderPlatformChart(platforms) {
            const ctx = document.getElementById('platformChart').getContext('2d');
            
            if (platformChart) {
                platformChart.destroy();
            }

            const platformColors = {
                'Zepto': '#8B5CF6',
                'Blinkit': '#FBBF24',
                'BigBasket': '#10B981',
                'Instamart': '#F97316',
                'Amazon Fresh': '#3B82F6',
                'Amazon': '#F59E0B',
                'Flipkart': '#2563EB',
                'Flipkart Minutes': '#6366F1',
                'JioMart': '#EF4444',
                'JioMart Quick': '#EC4899'
            };

            platformChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: platforms.map(p => p.platform),
                    datasets: [
                        {
                            label: 'Products Scraped',
                            data: platforms.map(p => p.total_products || 0),
                            backgroundColor: platforms.map(p => platformColors[p.platform] || '#CBD5E1'),
                        },
                        {
                            label: 'Relevant Products',
                            data: platforms.map(p => p.relevant_products || 0),
                            backgroundColor: platforms.map(p => (platformColors[p.platform] || '#CBD5E1') + '80'),
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Render platform table
        function renderPlatformTable(platforms) {
            const tbody = document.getElementById('platformTable');
            
            if (!platforms || platforms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-400">No platform data</td></tr>';
                return;
            }

            tbody.innerHTML = platforms.map(p => {
                const successRate = p.total_logs > 0 ? Math.round((p.successful || 0) / p.total_logs * 100) : 0;
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${p.platform}</td>
                        <td class="px-4 py-3">${p.total_logs || 0}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs ${successRate >= 80 ? 'bg-green-100 text-green-700' : successRate >= 50 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">
                                ${successRate}%
                            </span>
                        </td>
                        <td class="px-4 py-3">${p.total_products || 0}</td>
                        <td class="px-4 py-3">${p.relevant_products || 0}</td>
                        <td class="px-4 py-3">${(p.avg_html_size || 0).toFixed(1)} KB</td>
                        <td class="px-4 py-3">${(p.avg_latency || 0).toFixed(0)}ms</td>
                    </tr>
                `;
            }).join('');
        }

        // Render logs table
        function renderLogs(logs) {
            const tbody = document.getElementById('logsTable');
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-8 text-center text-gray-400">No logs yet</td></tr>';
                return;
            }

            tbody.innerHTML = logs.slice(0, 50).map(log => {
                const time = new Date(log.created_at).toLocaleString();
                const sourceColors = {
                    'device': 'bg-green-100 text-green-700',
                    'ai_fallback': 'bg-purple-100 text-purple-700',
                    'playwright': 'bg-yellow-100 text-yellow-700'
                };
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 text-gray-500">${time}</td>
                        <td class="px-3 py-2 font-medium">${log.platform}</td>
                        <td class="px-3 py-2 text-gray-600 truncate max-w-xs">${log.search_query || '-'}</td>
                        <td class="px-3 py-2">
                            <span class="px-2 py-0.5 rounded text-xs ${sourceColors[log.scrape_source] || 'bg-gray-100 text-gray-600'}">
                                ${log.scrape_source || 'unknown'}
                            </span>
                        </td>
                        <td class="px-3 py-2">${log.products_scraped || 0} ‚Üí ${log.relevant_products || 0}</td>
                        <td class="px-3 py-2">
                            ${log.success 
                                ? '<span class="text-green-500">‚úì</span>' 
                                : '<span class="text-red-500">‚úó</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Populate platform filter
        function populatePlatformFilter() {
            const platforms = [...new Set(allLogs.map(l => l.platform))].filter(Boolean);
            const select = document.getElementById('logPlatformFilter');
            select.innerHTML = '<option value="">All Platforms</option>' + 
                platforms.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        // Filter logs by platform
        function filterLogs() {
            const platform = document.getElementById('logPlatformFilter').value;
            const filtered = platform 
                ? allLogs.filter(l => l.platform === platform)
                : allLogs;
            renderLogs(filtered);
        }

        // Refresh data
        function refreshData() {
            loadDashboard();
        }

        // UI State helpers
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('noDataState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
        }

        function showNoData() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('noDataState').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('noDataState').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
        }
    </script>
</body>
</html>
